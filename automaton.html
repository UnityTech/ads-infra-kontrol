<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Automaton &#8212; kontrol 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Use Cases" href="use-cases.html" />
    <link rel="prev" title="Kontrol" href="kontrol.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="use-cases.html" title="Use Cases"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="kontrol.html" title="Kontrol"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">kontrol 1.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="automaton">
<h1>Automaton<a class="headerlink" href="#automaton" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h3>
<p><em>Automaton</em> is a small <a class="reference external" href="https://www.python.org/">Python</a> tool that implements a finite state machine running
shell scripts. It is easily configured via a YAML manifest and will implement whatever
lifecycle you wish to enforce. The tool will install itself under <em>/usr/local/bin</em> or
<em>/usr/bin</em> depending on the environment.</p>
<p><em>Automaton</em> will flow from state to state and run a user-defined script at each transition.
When starting <em>Automaton</em> will setup a unix socket and listen for commands. The machine will
start in the prescribed state and always transition to its terminal state before shutting down
(which is convenient to implement graceful shutdown procedures).</p>
</div>
<div class="section" id="getting-started">
<h3>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h3>
<p>Write a first simple YAML manifest called <em>bot.yml</em> with 3 states <em>A</em>, <em>B</em> and <em>C</em>. <em>A</em>
can switch to <em>B</em> and <em>B</em> will pause for 5 seconds and write to a local <em>foo</em> file. Note
<em>B</em> can transition to itself but not <em>A</em>. <em>C</em> is the terminal state the machine will
transition to upon shutdown.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/A-B.png"><img alt="_images/A-B.png" src="_images/A-B.png" style="width: 75%;" /></a>
</div>
<p>The YAML manifest will for instance look like:</p>
<div class="highlight-YAML"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">initial</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">A</span>
<span class="l l-Scalar l-Scalar-Plain">terminal</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="l l-Scalar l-Scalar-Plain">states</span><span class="p p-Indicator">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tag</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">A</span>
  <span class="l l-Scalar l-Scalar-Plain">shell</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">echo starting</span>
  <span class="l l-Scalar l-Scalar-Plain">next</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tag</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">B</span>
  <span class="l l-Scalar l-Scalar-Plain">shell</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
    <span class="no">sleep 5</span>
    <span class="no">echo $INPUT &gt; foo</span>
  <span class="l l-Scalar l-Scalar-Plain">next</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">A</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tag</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">C</span>
  <span class="l l-Scalar l-Scalar-Plain">shell</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
    <span class="no">echo terminating</span>
</pre></div>
</div>
<p>Each block in the <em>states</em> array must contain the state tag, a valid shell snippet and what
transitions are allowed via the <em>next</em> array. Please note you can use a glob pattern and that
not specifying anything means the state is final.</p>
<p>Simply run <em>Automaton</em> on the command line and specify our YAML manifest and the name of
the socket to create:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>$ automaton bot.yml -d -s /tmp/sock
</pre></div>
</div>
<p>The machine will start and automatically switch to its initial state. You can test it is now
in the <em>A</em> state by using socat to write to the socket:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> STATE <span class="p">|</span> socat - /tmp/sock
A
</pre></div>
</div>
<p>Now let&#8217;s trip it to the B state. After 5 seconds you should be able to see that <em>foo</em> file.</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="nv">$echo</span> GOTO B <span class="p">|</span> socat - /tmp/sock
OK
<span class="nv">$ls</span> -s foo
<span class="m">0</span> foo
</pre></div>
</div>
<p>Since <em>B</em> can transition to itself let&#8217;s trip again but this time we&#8217;ll specify some input
payload. What&#8217;s echoed to the socat after the state will be passed down verbatim to the shell
script as the <strong>$INPUT</strong> environment variable. For instance:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="nv">$echo</span> GOTO B hello <span class="p">|</span> socat - /tmp/sock
OK
<span class="nv">$cat</span> foo
hello
</pre></div>
</div>
</div>
</div>
<div class="section" id="states">
<h2>States<a class="headerlink" href="#states" title="Permalink to this headline">¶</a></h2>
<div class="section" id="transitioning">
<h3>Transitioning<a class="headerlink" href="#transitioning" title="Permalink to this headline">¶</a></h3>
<p>You can transition to a target state either asynchronously using <em>GOTO</em> or blocking using
<em>WAIT</em>. Both commands will send an acknowledgement back: either <strong>OK</strong> if the transition was
successful or <strong>KO</strong> if the target state is invalid. Please be aware that depending on the
script a <em>WAIT</em> command might take some time: be sure to <em>socat</em> with a timeout in that
case.</p>
<p>You can pass arbitrary payload as well after the state. This payload will be passed down
during the transition to the shell script via the <strong>$INPUT</strong> variable. This variable is free-form
and can be wathever. For instance:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="nv">$echo</span> GOTO B <span class="s1">&#39;{&quot;counter&quot;: 123}&#39;</span> <span class="p">|</span> socat - /tmp/sock
OK
</pre></div>
</div>
<p>Whenever transitioning to a state the associate shell script will be executed and run from
where the <em>automaton</em> command was invoked. The shell script standard outputs will be piped
and logged in debug mode.</p>
<p>The unix socket used for communication is always passed down as the $SOCKET variable. You can
in addition set variables at any moment by using the <em>SET</em> command. Those variables will be
set for any subsequent shell script invokations. For instance if you wish <strong>$COUNTER</strong> to be
made available at the next transition and set it to &#8220;123&#8221; you can do:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="nv">$echo</span> SET COUNTER <span class="m">123</span> <span class="p">|</span> socat - /tmp/sock
OK
</pre></div>
</div>
<p>Please note you can send commands to the machine from <em>within</em> a script. This is handy to
implement cycles or to trip the machine based on some condition. For instance the following
state will transition to itself every minute:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tag X</span>
  <span class="l l-Scalar l-Scalar-Plain">shell</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
    <span class="no">echo looping state</span>
    <span class="no">sleep 60</span>
    <span class="no">echo GOTO X | socat - $SOCKET</span>
</pre></div>
</div>
<p>Whenever transitioning the current shell script will be forcefully killed (provided it is
still running). The running script will be given a grace period of a few seconds to complete
after which it will abort on a <em>SIGKILL</em>.</p>
</div>
<div class="section" id="initial-terminal-states">
<h3>Initial &amp; terminal states<a class="headerlink" href="#initial-terminal-states" title="Permalink to this headline">¶</a></h3>
<p>When <em>automaton</em> is invoked it will automatically transition into its <em>initial</em> state. Whenever
the process terminates it will first transition the machine to its <em>terminal</em> state. This
state can be reached from any other state and will run last. You can take advantage of this
mechanism to perform some cleanup tasks as an example.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/unity-logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Automaton</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#getting-started">Getting started</a></li>
</ul>
</li>
<li><a class="reference internal" href="#states">States</a><ul>
<li><a class="reference internal" href="#transitioning">Transitioning</a></li>
<li><a class="reference internal" href="#initial-terminal-states">Initial &amp; terminal states</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="kontrol.html" title="previous chapter">Kontrol</a></li>
      <li>Next: <a href="use-cases.html" title="next chapter">Use Cases</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2017, Unity Technologies.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  
  </body>
</html>